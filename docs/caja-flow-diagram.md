# Flujo del Sistema de Caja - Diagrama

## ğŸ”„ Flujo Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SISTEMA DE CAJA OPTIMIZADO                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      1. APERTURA DE CAJA                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Usuario                Frontend                Backend
       â”‚                      â”‚                       â”‚
       â”‚â”€â”€Abrir Cajaâ”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚â”€POST /cash-registerâ”€â”€>â”‚
       â”‚                      â”‚  campus_id: 1         â”‚
       â”‚                      â”‚  status: 'abierta'    â”‚
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚                   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
       â”‚                      â”‚                   â”‚ Validarâ”‚
       â”‚                      â”‚                   â”‚  No    â”‚
       â”‚                      â”‚                   â”‚ existe â”‚
       â”‚                      â”‚                   â”‚  otra  â”‚
       â”‚                      â”‚                   â”‚ abiertaâ”‚
       â”‚                      â”‚                   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚<â”€â”€âœ… CashRegisterâ”€â”€â”€â”€â”€â”‚
       â”‚                      â”‚      created          â”‚
       â”‚<â”€â”€âœ… Caja Abiertaâ”€â”€â”€â”€â”‚                       â”‚
       â”‚                      â”‚                       â”‚

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  2. REGISTRO DE TRANSACCIÃ“N                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Usuario                Frontend                Backend
       â”‚                      â”‚                       â”‚
       â”‚â”€â”€Pago Efectivoâ”€â”€â”€â”€â”€â”€>â”‚                       â”‚
       â”‚  $500                â”‚                       â”‚
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚â”€POST /transactionsâ”€â”€â”€>â”‚
       â”‚                      â”‚  payment_method: cash â”‚
       â”‚                      â”‚  campus_id: 1         â”‚
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚                   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
       â”‚                      â”‚                   â”‚  Auto  â”‚
       â”‚                      â”‚                   â”‚ Asignarâ”‚
       â”‚                      â”‚                   â”‚  Caja  â”‚
       â”‚                      â”‚                   â”‚ Activa â”‚
       â”‚                      â”‚                   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚                   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
       â”‚                      â”‚                   â”‚ Buscar â”‚
       â”‚                      â”‚                   â”‚  Caja  â”‚
       â”‚                      â”‚                   â”‚ Abiertaâ”‚
       â”‚                      â”‚                   â”‚campus 1â”‚
       â”‚                      â”‚                   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚                   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
       â”‚                      â”‚                   â”‚Asignar â”‚
       â”‚                      â”‚                   â”‚cash_   â”‚
       â”‚                      â”‚                   â”‚registerâ”‚
       â”‚                      â”‚                   â”‚  _id   â”‚
       â”‚                      â”‚                   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚<â”€â”€âœ… Transactionâ”€â”€â”€â”€â”€â”€â”‚
       â”‚                      â”‚    saved              â”‚
       â”‚<â”€â”€âœ… Registradoâ”€â”€â”€â”€â”€â”€â”‚                       â”‚
       â”‚                      â”‚                       â”‚

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     3. REGISTRO DE GASTO                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Usuario                Frontend                Backend
       â”‚                      â”‚                       â”‚
       â”‚â”€â”€Gasto Efectivoâ”€â”€â”€â”€â”€>â”‚                       â”‚
       â”‚  $200                â”‚                       â”‚
       â”‚  "PapelerÃ­a"         â”‚                       â”‚
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚â”€POST /gastosâ”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                      â”‚  method: 'Efectivo'   â”‚
       â”‚                      â”‚  campus_id: 1         â”‚
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚                   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
       â”‚                      â”‚                   â”‚Normalizâ”‚
       â”‚                      â”‚                   â”‚   ar   â”‚
       â”‚                      â”‚                   â”‚'Efectivâ”‚
       â”‚                      â”‚                   â”‚o'â†’'cashâ”‚
       â”‚                      â”‚                   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚                   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
       â”‚                      â”‚                   â”‚  Auto  â”‚
       â”‚                      â”‚                   â”‚ Asignarâ”‚
       â”‚                      â”‚                   â”‚  Caja  â”‚
       â”‚                      â”‚                   â”‚ Activa â”‚
       â”‚                      â”‚                   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚<â”€â”€âœ… Gasto savedâ”€â”€â”€â”€â”€â”€â”‚
       â”‚                      â”‚                       â”‚
       â”‚<â”€â”€âœ… Registradoâ”€â”€â”€â”€â”€â”€â”‚                       â”‚
       â”‚                      â”‚                       â”‚

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   4. CÃLCULO DE BALANCE                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Usuario                Frontend                Backend
       â”‚                      â”‚                       â”‚
       â”‚â”€â”€Ver Balanceâ”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚â”€GET /cash-register/1â”€>â”‚
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚                   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
       â”‚                      â”‚                   â”‚ Sumar  â”‚
       â”‚                      â”‚                   â”‚Ingresosâ”‚
       â”‚                      â”‚                   â”‚  WHERE â”‚
       â”‚                      â”‚                   â”‚method  â”‚
       â”‚                      â”‚                   â”‚  IN    â”‚
       â”‚                      â”‚                   â”‚['cash',â”‚
       â”‚                      â”‚                   â”‚'Efectivâ”‚
       â”‚                      â”‚                   â”‚  o']   â”‚
       â”‚                      â”‚                   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚                   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
       â”‚                      â”‚                   â”‚ Sumar  â”‚
       â”‚                      â”‚                   â”‚ Gastos â”‚
       â”‚                      â”‚                   â”‚  WHERE â”‚
       â”‚                      â”‚                   â”‚method  â”‚
       â”‚                      â”‚                   â”‚  IN    â”‚
       â”‚                      â”‚                   â”‚['cash',â”‚
       â”‚                      â”‚                   â”‚'Efectivâ”‚
       â”‚                      â”‚                   â”‚  o']   â”‚
       â”‚                      â”‚                   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚                   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
       â”‚                      â”‚                   â”‚Balance:â”‚
       â”‚                      â”‚                   â”‚Initial â”‚
       â”‚                      â”‚                   â”‚   +    â”‚
       â”‚                      â”‚                   â”‚Ingresosâ”‚
       â”‚                      â”‚                   â”‚   -    â”‚
       â”‚                      â”‚                   â”‚ Gastos â”‚
       â”‚                      â”‚                   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚<â”€â”€Balance: $1300â”€â”€â”€â”€â”€â”€â”‚
       â”‚<â”€â”€Balance: $1300â”€â”€â”€â”€â”€â”‚                       â”‚
       â”‚                      â”‚                       â”‚

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     5. CIERRE DE CAJA                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Usuario                Frontend                Backend
       â”‚                      â”‚                       â”‚
       â”‚â”€â”€Cerrar Cajaâ”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
       â”‚  Conteo: $1300       â”‚                       â”‚
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚                   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
       â”‚                      â”‚                   â”‚Calcularâ”‚
       â”‚                      â”‚                   â”‚Balance â”‚
       â”‚                      â”‚                   â”‚Esperadoâ”‚
       â”‚                      â”‚                   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                      â”‚                       â”‚
       â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
       â”‚          â”‚ âš ï¸  Diferencia        â”‚           â”‚
       â”‚          â”‚                       â”‚           â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Conteo: $1300         â”‚           â”‚
       â”‚          â”‚ Esperado: $1300       â”‚           â”‚
       â”‚          â”‚ Diferencia: $0        â”‚           â”‚
       â”‚          â”‚                       â”‚           â”‚
       â”‚          â”‚ Â¿Continuar?           â”‚           â”‚
       â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
       â”‚                      â”‚                       â”‚
       â”‚â”€â”€âœ… Confirmarâ”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚â”€PUT /cash-register/1â”€>â”‚
       â”‚                      â”‚  final_amount: 1300   â”‚
       â”‚                      â”‚  status: 'cerrada'    â”‚
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚                   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
       â”‚                      â”‚                   â”‚Validar â”‚
       â”‚                      â”‚                   â”‚  caja  â”‚
       â”‚                      â”‚                   â”‚ abiertaâ”‚
       â”‚                      â”‚                   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚                   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
       â”‚                      â”‚                   â”‚Guardar â”‚
       â”‚                      â”‚                   â”‚final_  â”‚
       â”‚                      â”‚                   â”‚amount  â”‚
       â”‚                      â”‚                   â”‚closed_ â”‚
       â”‚                      â”‚                   â”‚  at    â”‚
       â”‚                      â”‚                   â”‚status= â”‚
       â”‚                      â”‚                   â”‚cerrada â”‚
       â”‚                      â”‚                   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                      â”‚                       â”‚
       â”‚                      â”‚<â”€â”€âœ… Cerradaâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚<â”€â”€âœ… Caja Cerradaâ”€â”€â”€â”€â”‚                       â”‚
       â”‚                      â”‚                       â”‚

```

## ğŸ“Š Estructura de Datos

### CashRegister (Tabla Principal)
```json
{
  "id": 1,
  "campus_id": 1,
  "initial_amount": 1000.00,
  "initial_amount_cash": {
    "1000": 1,
    "500": 0,
    "200": 0,
    ...
  },
  "final_amount": 1300.00,
  "final_amount_cash": {
    "1000": 1,
    "200": 1,
    "100": 1,
    ...
  },
  "next_day": 300.00,
  "next_day_cash": {
    "200": 1,
    "100": 1
  },
  "status": "cerrada",
  "opened_at": "2025-09-30 08:00:00",
  "closed_at": "2025-09-30 20:00:00",
  "notes": "Cierre sin observaciones"
}
```

### Transaction (RelaciÃ³n 1:N)
```json
{
  "id": 123,
  "cash_register_id": 1,  // â† Auto-asignado
  "student_id": 456,
  "campus_id": 1,
  "payment_method": "cash",
  "amount": 500.00,
  "paid": true,
  "transaction_type": "income",
  "payment_date": "2025-09-30 10:30:00"
}
```

### Gasto (RelaciÃ³n 1:N)
```json
{
  "id": 789,
  "cash_register_id": 1,  // â† Auto-asignado
  "campus_id": 1,
  "method": "Efectivo",   // â† Normalizado a 'cash'
  "amount": 200.00,
  "concept": "PapelerÃ­a",
  "category": "Administrativo",
  "date": "2025-09-30 14:00:00"
}
```

## ğŸ” Validaciones Clave

### 1. Apertura de Caja
```
âœ… No debe haber otra caja abierta en el mismo campus
âœ… El monto inicial debe ser >= 0
âœ… Si initial_amount = 0, tomar del next_day anterior
```

### 2. Registro de TransacciÃ³n/Gasto en Efectivo
```
âœ… Auto-asignar cash_register_id si method IN ['cash', 'Efectivo']
âš ï¸  Advertir si no hay caja abierta (no bloquear)
âœ… Normalizar mÃ©todo de pago
```

### 3. CÃ¡lculo de Balance
```
âœ… Incluir TODAS las variaciones de efectivo
âœ… Redondear a 2 decimales
âœ… Balance = initial_amount + ingresos - gastos
```

### 4. Cierre de Caja
```
âœ… La caja debe estar abierta
âœ… Comparar conteo manual vs balance calculado
âš ï¸  Mostrar diferencia si existe
âœ… Permitir cerrar con diferencia (previa confirmaciÃ³n)
âœ… Guardar next_day para siguiente caja
```

---

**Ãšltima actualizaciÃ³n:** 30 de septiembre de 2025
